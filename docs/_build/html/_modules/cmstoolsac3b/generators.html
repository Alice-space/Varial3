
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cmstoolsac3b.generators &mdash; CmsAnalysisAC3B 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/celery.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CmsAnalysisAC3B 0.1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">CmsAnalysisAC3B 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for cmstoolsac3b.generators</h1><div class="highlight"><pre>
<span class="c"># generators.py</span>

<span class="c">################################################################### utility ###</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="k">def</span> <span class="nf">_iterableize</span><span class="p">(</span><span class="n">obj_or_iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;provides iterable for [obj OR iterable(obj)]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_or_iterable</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">obj_or_iterable</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">o</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">obj_or_iterable</span>

<span class="k">def</span> <span class="nf">_filt_req</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="n">filter_dict</span><span class="p">):</span> <span class="c"># generator over True/False</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filter_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">value</span> <span class="c"># handle iterable</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;search&quot;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span> <span class="c"># handle non-iterable</span>

<div class="viewcode-block" id="debug_printer"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.debug_printer">[docs]</a><span class="k">def</span> <span class="nf">debug_printer</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">print_obj</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print objects and their type on flying by. Object printing can be turned off.</span>

<span class="sd">    :param iterable:    An iterable with objects</span>
<span class="sd">    :yields:            same as input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;DEBUG: debug_printer: obj type: &quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_obj</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;DEBUG: debug_printer: obj:      &quot;</span><span class="p">,</span> <span class="n">obj</span>
        <span class="k">yield</span> <span class="n">obj</span>
</div>
<div class="viewcode-block" id="consume_n_count"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.consume_n_count">[docs]</a><span class="k">def</span> <span class="nf">consume_n_count</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walks over iterable and counts number of items.</span>

<span class="sd">    :returns:   integer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span>
</div>
<div class="viewcode-block" id="filter"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.filter">[docs]</a><span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">key_value_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Only wrappers with specified attributes can pass this generator.</span>

<span class="sd">    :param  wrps:           Wrapper iterable</span>
<span class="sd">    :param  key_value_dict: dictionary of attributes, see cmstoolsac3b_example</span>
<span class="sd">    :yields:                Wrapper</span>

<span class="sd">    **Example:** (Every key in the given dictonairy is tested, where the key</span>
<span class="sd">    is the tested attribute of the wrapper. A single value, a list of values or</span>
<span class="sd">    a regular expression can be evaluated)::</span>

<span class="sd">        filter(</span>
<span class="sd">            wrappers,</span>
<span class="sd">            {</span>
<span class="sd">                &quot;is_data&quot;   : False,                # single value</span>
<span class="sd">                &quot;analyzer&quot;  : [&quot;AnaEt&quot;, &quot;AnaDR&quot;]    # candidate list</span>
<span class="sd">                &quot;name&quot;      : re.compile(&quot;histo&quot;)   # regular expression</span>
<span class="sd">            }</span>
<span class="sd">        )</span>

<span class="sd">    If the **key_value_dict** is empty, all wrappers pass the filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key_value_dict</span><span class="p">:</span> <span class="n">key_value_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_value_dict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span>
    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">ifilter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">wrp</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">_filt_req</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="n">key_value_dict</span><span class="p">)),</span>
        <span class="n">wrps</span>
    <span class="p">)</span>
</div>
<div class="viewcode-block" id="filter_inv"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.filter_inv">[docs]</a><span class="k">def</span> <span class="nf">filter_inv</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">key_value_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Just as filter, only inverted.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key_value_dict</span><span class="p">:</span> <span class="n">key_value_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_value_dict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span>
    <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">ifilter</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">wrp</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">_filt_req</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="n">key_value_dict</span><span class="p">)),</span>
        <span class="n">wrps</span>
    <span class="p">)</span>
</div>
<div class="viewcode-block" id="callback"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.callback">[docs]</a><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">filter_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do a special treatment for selected wrps! All wrps are yielded.</span>

<span class="sd">    :param wrps:        Wrapper iterable</span>
<span class="sd">    :param filter_dict: same as key_value_dict in ``filter(..)`` above</span>
<span class="sd">    :param func:        callable</span>
<span class="sd">    :yields:            Wrapper</span>

<span class="sd">    **Example:** If you wanted to color all passing MC histograms blue::</span>

<span class="sd">        def make_blue(wrp):</span>
<span class="sd">            wrp.histo.SetFillColor(ROOT.kBlue)</span>
<span class="sd">            return wrp # IMPORTANT! RETURN THE WRAPPER!</span>

<span class="sd">        callback(</span>
<span class="sd">            wrappers,</span>
<span class="sd">            {&quot;is_data&quot;: False}</span>
<span class="sd">            make_blue</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">wrp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_dict</span><span class="p">:</span> <span class="n">filter_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">_filt_req</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="n">filter_dict</span><span class="p">)):</span>
                <span class="n">wrp</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">wrp</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">wrp</span>
</div>
<div class="viewcode-block" id="sort"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.sort">[docs]</a><span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort stream after items in key_list. Loads full stream into memory.</span>

<span class="sd">    :param wrps:        Wrapper iterable</span>
<span class="sd">    :param key_list:    (List of) token(s) after which the stream is sorted.</span>
<span class="sd">                        First item has highest importance. If ``None``, then</span>
<span class="sd">                        ``[&#39;analyzer&#39;, &#39;name&#39;, &#39;is_data&#39;, &#39;sample&#39;]`` is used.</span>
<span class="sd">    :returns:           sorted list of wrappers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key_list</span><span class="p">:</span> <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;analyzer&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;is_data&#39;</span><span class="p">,</span> <span class="s">&#39;sample&#39;</span><span class="p">]</span>
    <span class="c"># python sorting is stable: Just sort by reversed key_list:</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_iterableize</span><span class="p">(</span><span class="n">key_list</span><span class="p">))):</span>
        <span class="n">wrps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wrps</span>
</div>
<div class="viewcode-block" id="group"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.group">[docs]</a><span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">key_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clusters stream into groups. wrps should be sorted.</span>

<span class="sd">    :param wrps:        Wrapper iterable</span>
<span class="sd">    :param key_func:    callable to group the wrappers. If ``None``, then</span>
<span class="sd">                        ``lambda w: w.analyzer + &quot;_&quot; + w.name`` is used.</span>
<span class="sd">    :yields:            Wrapper</span>

<span class="sd">    **Example:** This is neccessary before stacking, in order to have only</span>
<span class="sd">    same-observable-histograms stacked together::</span>

<span class="sd">        # wrappers has the names [&quot;h1&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h2&quot;]</span>
<span class="sd">        wrappers = group(wrappers)</span>
<span class="sd">        # result is like: [ (&quot;h1&quot;, &quot;h1&quot;), (&quot;h2&quot;, &quot;h2&quot;) ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key_func</span><span class="p">:</span> <span class="n">key_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">analyzer</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">w</span><span class="o">.</span><span class="n">name</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">key_func</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">g</span>
</div>
<div class="viewcode-block" id="split_data_mc"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.split_data_mc">[docs]</a><span class="k">def</span> <span class="nf">split_data_mc</span><span class="p">(</span><span class="n">wrps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split stream into data and mc stream.</span>

<span class="sd">    :param wrps:        Wrapper iterable</span>
<span class="sd">    :returns:           two wrapper iterators: ``(stream_data, stream_mc)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrp_a</span><span class="p">,</span> <span class="n">wrp_b</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">wrps</span><span class="p">)</span>
    <span class="n">data</span>         <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">is_data</span><span class="p">,</span> <span class="n">wrp_a</span><span class="p">)</span>
    <span class="n">mcee</span>         <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">ifilter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">is_data</span><span class="p">,</span> <span class="n">wrp_b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">mcee</span>
</div>
<div class="viewcode-block" id="debug_print"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.debug_print">[docs]</a><span class="k">def</span> <span class="nf">debug_print</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;DEBUG &quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints all passing items.</span>

<span class="sd">    **Implementation:** ::</span>

<span class="sd">        for wrp in wrps:</span>
<span class="sd">            print prefix, wrp.all_info()</span>
<span class="sd">            yield wrp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">wrp</span><span class="o">.</span><span class="n">all_info</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">wrp</span>

<span class="c">################################################################ operations ###</span></div>
<span class="kn">import</span> <span class="nn">operations</span> <span class="kn">as</span> <span class="nn">op</span>

<div class="viewcode-block" id="generate_op"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.generate_op">[docs]</a><span class="k">def</span> <span class="nf">generate_op</span><span class="p">(</span><span class="n">op_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms an operation with one argument into a generator.</span>

<span class="sd">    :param op_func: callable</span>
<span class="sd">    :returns:       generator</span>

<span class="sd">    **Example:** The ``lumi`` and ``int`` operations are generatorized below</span>
<span class="sd">    (notice that ``w1``,``w2`` and ``w3`` are iterables):</span>

<span class="sd">    &gt;&gt;&gt; from ROOT import TH1I</span>
<span class="sd">    &gt;&gt;&gt; from cmstoolsac3b.wrappers import HistoWrapper</span>
<span class="sd">    &gt;&gt;&gt; h1 = TH1I(&quot;h1&quot;, &quot;&quot;, 2, .5, 4.5)</span>
<span class="sd">    &gt;&gt;&gt; h1.Fill(1)</span>
<span class="sd">    1</span>
<span class="sd">    &gt;&gt;&gt; h1.Fill(3)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; w1 = [HistoWrapper(h1, lumi=2.)]</span>
<span class="sd">    &gt;&gt;&gt; gen_lumi = generate_op(op.lumi)</span>
<span class="sd">    &gt;&gt;&gt; w2 = list(gen_lumi(w1))</span>
<span class="sd">    &gt;&gt;&gt; w2[0].float</span>
<span class="sd">    2.0</span>
<span class="sd">    &gt;&gt;&gt; gen_int = generate_op(op.int)</span>
<span class="sd">    &gt;&gt;&gt; w3 = list(gen_int(w1))</span>
<span class="sd">    &gt;&gt;&gt; w3[0].float</span>
<span class="sd">    2.0</span>
<span class="sd">    &gt;&gt;&gt; w4 = list(gen_int(w1, useBinWidth=True))</span>
<span class="sd">    &gt;&gt;&gt; w4[0].float</span>
<span class="sd">    4.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">gen_op</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">op_func</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gen_op</span>
</div>
<span class="n">gen_stack</span> <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>  <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.stack)``</span>
<span class="n">gen_sum</span>   <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">sum</span><span class="p">)</span>    <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.sum)``</span>
<span class="n">gen_merge</span> <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">merge</span><span class="p">)</span>  <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.merge)``</span>
<span class="n">gen_prod</span>  <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span>   <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.prod)``</span>
<span class="n">gen_div</span>   <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">div</span><span class="p">)</span>    <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.div)``</span>
<span class="n">gen_lumi</span>  <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">lumi</span><span class="p">)</span>   <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.lumi)``</span>
<span class="n">gen_mv_in</span> <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">mv_in</span><span class="p">)</span>  <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.mv_in)``</span>
<span class="n">gen_int</span>   <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>    <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.int)``</span>
<span class="n">gen_int_l</span> <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">int_l</span><span class="p">)</span>  <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.int_l)``</span>
<span class="n">gen_int_r</span> <span class="o">=</span> <span class="n">generate_op</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">int_r</span><span class="p">)</span>  <span class="c">#: This is ``generate_op(cmstoolsac3b.operations.int_r)``</span>

<span class="c">############################################################### load / save ###</span>
<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">import</span> <span class="nn">histodispatch</span> <span class="kn">as</span> <span class="nn">dsp</span>
<span class="kn">from</span> <span class="nn">ROOT</span> <span class="kn">import</span> <span class="n">TFile</span>

<div class="viewcode-block" id="fs_content"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.fs_content">[docs]</a><span class="k">def</span> <span class="nf">fs_content</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Searches ``settings.DIR_FILESERVICE`` for samples and loads aliases.</span>

<span class="sd">    :yields:   FileServiceAlias</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">dsp</span><span class="o">.</span><span class="n">HistoDispatch</span><span class="p">()</span><span class="o">.</span><span class="n">fileservice_aliases</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">alias</span>
</div>
<div class="viewcode-block" id="pool_content"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.pool_content">[docs]</a><span class="k">def</span> <span class="nf">pool_content</span><span class="p">(</span><span class="n">filter_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields selected pool content.</span>

<span class="sd">    :param filter_dict: same as key_value_dict in ``filter(..)`` above</span>
<span class="sd">    :yields:    Wrappers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="n">dsp</span><span class="o">.</span><span class="n">HistoPool</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">filter_dict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pool_store_items"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.pool_store_items">[docs]</a><span class="k">def</span> <span class="nf">pool_store_items</span><span class="p">(</span><span class="n">wrps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves items in pool and yields them again.</span>

<span class="sd">    :param wrps:    Wrapper iterable</span>
<span class="sd">    :yields:        Wrapper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">.</span><span class="n">HistoPool</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">_iterableize</span><span class="p">(</span><span class="n">wrp</span><span class="p">):</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">wrp</span>
</div>
<div class="viewcode-block" id="pool_consume_n_count"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.pool_consume_n_count">[docs]</a><span class="k">def</span> <span class="nf">pool_consume_n_count</span><span class="p">(</span><span class="n">wrps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consumes wrappers into pool.</span>

<span class="sd">    **Implementation:** ::</span>

<span class="sd">        return consume_n_count(pool_store_items(wrps))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">consume_n_count</span><span class="p">(</span><span class="n">pool_store_items</span><span class="p">(</span><span class="n">wrps</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">aliases</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads histograms in histowrappers for aliases.</span>

<span class="sd">    :param aliases: Alias iterable</span>
<span class="sd">    :yields:        HistoWrapper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hd</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">.</span><span class="n">HistoDispatch</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">hd</span><span class="o">.</span><span class="n">load_histogram</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">filename_func</span><span class="p">,</span> <span class="n">suffices</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves passing wrps to disk, plus .info file with the wrapper infos.</span>

<span class="sd">    :param wrps:            Wrapper iterable</span>
<span class="sd">    :param filename_func:   callable that returns path and filename without</span>
<span class="sd">                            suffix.</span>
<span class="sd">    :param suffices:        list of suffices</span>

<span class="sd">    **Example:** ::</span>

<span class="sd">        save(</span>
<span class="sd">            wrappers,</span>
<span class="sd">            lambda wrp: OUTPUT_DIR + wrp.name,</span>
<span class="sd">            [.root, .png]           # DEFAULT: settings.rootfile_postfixes</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">suffices</span><span class="p">:</span> <span class="n">suffices</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">rootfile_postfixes</span>
    <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="s">&quot;primary_object&quot;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_func</span><span class="p">(</span><span class="n">wrp</span><span class="p">)</span>
            <span class="n">prim_obj</span> <span class="o">=</span> <span class="n">wrp</span><span class="o">.</span><span class="n">primary_object</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffices</span><span class="p">:</span>
                <span class="n">prim_obj</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="s">&quot;write_info_file&quot;</span><span class="p">):</span>
                <span class="n">wrp</span><span class="o">.</span><span class="n">write_info_file</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.info&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">wrp</span>

<span class="c">################################################### application &amp; packaging ###</span></div>
<span class="kn">import</span> <span class="nn">rendering</span> <span class="kn">as</span> <span class="nn">rnd</span>

<div class="viewcode-block" id="apply_histo_fillcolor"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.apply_histo_fillcolor">[docs]</a><span class="k">def</span> <span class="nf">apply_histo_fillcolor</span><span class="p">(</span><span class="n">wrps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses ``histo.SetFillColor``. Colors from utilities.settings</span>

<span class="sd">    :param wrps:    HistoWrapper iterable</span>
<span class="sd">    :yields:        HistoWrapper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wrp</span><span class="p">,</span> <span class="s">&quot;histo&quot;</span><span class="p">):</span>
            <span class="n">fill_color</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_fill_color</span><span class="p">(</span><span class="n">wrp</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fill_color</span><span class="p">:</span>
                <span class="n">wrp</span><span class="o">.</span><span class="n">histo</span><span class="o">.</span><span class="n">SetFillColor</span><span class="p">(</span><span class="n">fill_color</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">wrp</span>
</div>
<div class="viewcode-block" id="fs_filter_sort_load"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.fs_filter_sort_load">[docs]</a><span class="k">def</span> <span class="nf">fs_filter_sort_load</span><span class="p">(</span><span class="n">filter_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Packaging of filtering, sorting and loading.</span>

<span class="sd">    :param filter_dict: see function filter(...) above</span>
<span class="sd">    :param sort_keys:   see function sort(...) above</span>
<span class="sd">    :yields:            HistoWrapper</span>

<span class="sd">    **Implementation:** ::</span>

<span class="sd">        wrps = fs_content()</span>
<span class="sd">        wrps = filter(wrps, filter_dict)</span>
<span class="sd">        wrps = sort(wrps, key_list)</span>
<span class="sd">        return load(wrps)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrps</span> <span class="o">=</span> <span class="n">fs_content</span><span class="p">()</span>
    <span class="n">wrps</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">filter_dict</span><span class="p">)</span>
    <span class="n">wrps</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">sort_keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">wrps</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="fs_mc_stack"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.fs_mc_stack">[docs]</a><span class="k">def</span> <span class="nf">fs_mc_stack</span><span class="p">(</span><span class="n">filter_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">merge_mc_key_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delivers only MC stacks, no data, from fileservice.</span>

<span class="sd">    :param filter_dict:         see function filter(...) above</span>
<span class="sd">    :param merge_mc_key_func:   key function for python sorted(...), default</span>
<span class="sd">                                tries to sort after stack position</span>
<span class="sd">    :yields:                    StackWrapper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">merge_mc_key_func</span><span class="p">:</span>
        <span class="n">merge_mc_key_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_stack_position</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>
    <span class="n">loaded</span> <span class="o">=</span> <span class="n">fs_filter_sort_load</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">loaded</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>

        <span class="c"># merge mc samples (merge also normalizes to lumi = 1.)</span>
        <span class="n">mc_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">merge_mc_key_func</span><span class="p">)</span>
        <span class="n">mc_groupd</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">mc_sorted</span><span class="p">,</span> <span class="n">merge_mc_key_func</span><span class="p">)</span>
        <span class="n">mc_merged</span> <span class="o">=</span> <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">mc_groupd</span><span class="p">)</span>
        <span class="n">mc_colord</span> <span class="o">=</span> <span class="n">apply_histo_fillcolor</span><span class="p">(</span><span class="n">mc_merged</span><span class="p">)</span>

        <span class="c"># stack mc</span>
        <span class="n">mc_stack</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mc_colord</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">mc_stack</span>
</div>
<div class="viewcode-block" id="mc_stack_n_data_sum"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.mc_stack_n_data_sum">[docs]</a><span class="k">def</span> <span class="nf">mc_stack_n_data_sum</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">merge_mc_key_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stacks MC histos and merges data, input needs to be sorted and grouped.</span>

<span class="sd">    The output are tuples of MC stacks and data histograms.</span>
<span class="sd">    ATTENTION: This crashes, if the proper histograms are not present!</span>

<span class="sd">    :param wrps:                Iterables of HistoWrapper (grouped)</span>
<span class="sd">    :param merge_mc_key_func:   key function for python sorted(...), default</span>
<span class="sd">                                tries to sort after stack position</span>
<span class="sd">    :yields:                    (StackWrapper, HistoWrapper)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">merge_mc_key_func</span><span class="p">:</span>
        <span class="n">merge_mc_key_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_stack_position</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>

        <span class="c"># split stream</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">split_data_mc</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span>

        <span class="c"># sum up data</span>
        <span class="n">data_sum</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data_lumi</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">lumi</span><span class="p">(</span><span class="n">data_sum</span><span class="p">)</span>

        <span class="c"># merge mc samples (merge also normalizes to lumi = 1.)</span>
        <span class="n">mc_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">merge_mc_key_func</span><span class="p">)</span>
        <span class="n">mc_groupd</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">mc_sorted</span><span class="p">,</span> <span class="n">merge_mc_key_func</span><span class="p">)</span>
        <span class="n">mc_merged</span> <span class="o">=</span> <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">mc_groupd</span><span class="p">)</span>
        <span class="n">mc_colord</span> <span class="o">=</span> <span class="n">apply_histo_fillcolor</span><span class="p">(</span><span class="n">mc_merged</span><span class="p">)</span>

        <span class="c"># stack mc</span>
        <span class="n">mc_norm</span> <span class="o">=</span> <span class="n">gen_prod</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">mc_colord</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">data_lumi</span><span class="p">)))</span>
        <span class="n">mc_stack</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mc_norm</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">mc_stack</span><span class="p">,</span> <span class="n">data_sum</span>
</div>
<div class="viewcode-block" id="fs_mc_stack_n_data_sum"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.fs_mc_stack_n_data_sum">[docs]</a><span class="k">def</span> <span class="nf">fs_mc_stack_n_data_sum</span><span class="p">(</span><span class="n">filter_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">merge_mc_key_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The full job to stacked histos and data, directly from fileservice.</span>

<span class="sd">    The output are tuples of MC stacks and data histograms.</span>
<span class="sd">    ATTENTION: This crashes, if the proper histograms are not present!</span>

<span class="sd">    :param filter_dict:         see function filter(...) above</span>
<span class="sd">    :param merge_mc_key_func:   key function for python sorted(...), default</span>
<span class="sd">                                tries to sort after stack position</span>
<span class="sd">    :yields:                    (StackWrapper, HistoWrapper)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loaded</span> <span class="o">=</span> <span class="n">fs_filter_sort_load</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">loaded</span><span class="p">)</span> <span class="c"># default: group by analyzer_histo (the fs histo &#39;ID&#39;)</span>
    <span class="k">return</span> <span class="n">mc_stack_n_data_sum</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">merge_mc_key_func</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="make_canvas_builder"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.make_canvas_builder">[docs]</a><span class="k">def</span> <span class="nf">make_canvas_builder</span><span class="p">(</span><span class="n">grps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yields instanciated CanvasBuilders.</span>

<span class="sd">    :param grps:    grouped or ungrouped Wrapper iterable</span>
<span class="sd">                    if grouped: on canvas for each group</span>
<span class="sd">    :yields:        CanvasBuilder instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">:</span>
        <span class="n">grp</span> <span class="o">=</span> <span class="n">_iterableize</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">rnd</span><span class="o">.</span><span class="n">CanvasBuilder</span><span class="p">(</span><span class="n">grp</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="decorate"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.decorate">[docs]</a><span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">wrps</span><span class="p">,</span> <span class="n">decorators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorate any iterable with a list of decorators.</span>

<span class="sd">    :param wrps:        Wrapper (or CanvasBuilder) iterable</span>
<span class="sd">    :param decorators:  list of decorator classes.</span>
<span class="sd">    :yields:            Wrapper (or CanvasBuilder)</span>

<span class="sd">    **Example:** ::</span>

<span class="sd">        result = decorate([CanvasBuilder, ...], [Legend, TextBox])</span>
<span class="sd">        # result = [Legend(TextBox(CanvasBuilder)), ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">wrp</span> <span class="ow">in</span> <span class="n">wrps</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dec</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">wrp</span> <span class="o">=</span> <span class="n">dec</span><span class="p">(</span><span class="n">wrp</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">wrp</span>
</div>
<div class="viewcode-block" id="build_canvas"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.build_canvas">[docs]</a><span class="k">def</span> <span class="nf">build_canvas</span><span class="p">(</span><span class="n">bldrs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the ``build_canvas()`` method and returns the result.</span>

<span class="sd">    :param bldrs:   CanvasBuilder iterable</span>
<span class="sd">    :yields:        CanvasWrapper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">bldr</span> <span class="ow">in</span> <span class="n">bldrs</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">bldr</span><span class="o">.</span><span class="n">build_canvas</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="canvas"><a class="viewcode-back" href="../../generators.html#cmstoolsac3b.generators.canvas">[docs]</a><span class="k">def</span> <span class="nf">canvas</span><span class="p">(</span><span class="n">grps</span><span class="p">,</span> 
           <span class="n">decorators</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span> 
           <span class="n">callback_filter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
           <span class="n">callback_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Packaging of canvas builder, decorating, callback and canvas building.</span>

<span class="sd">    :param grps:            grouped or ungrouped Wrapper iterable</span>
<span class="sd">                            if grouped: on canvas for each group</span>
<span class="sd">    :param decorators:      see function decorate(...) above</span>
<span class="sd">    :param callback_filter: see function callback(...) above (param filter_dict there)</span>
<span class="sd">    :param callback_func:   see function callback(...) above</span>
<span class="sd">    :yields:                CanvasWrapper</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">put_ana_histo_name</span><span class="p">(</span><span class="n">grps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">renderers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;analyzer&quot;</span><span class="p">):</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">renderers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">analyzer</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">grp</span><span class="o">.</span><span class="n">name</span>
            <span class="k">yield</span> <span class="n">grp</span>
    <span class="n">grps</span> <span class="o">=</span> <span class="n">make_canvas_builder</span><span class="p">(</span><span class="n">grps</span><span class="p">)</span>            <span class="c"># a builder for every group</span>
    <span class="n">grps</span> <span class="o">=</span> <span class="n">put_ana_histo_name</span><span class="p">(</span><span class="n">grps</span><span class="p">)</span>             <span class="c"># only applies to fs histos</span>
    <span class="n">grps</span> <span class="o">=</span> <span class="n">decorate</span><span class="p">(</span><span class="n">grps</span><span class="p">,</span> <span class="n">decorators</span><span class="p">)</span>           <span class="c"># apply decorators</span>
    <span class="n">grps</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">grps</span><span class="p">,</span> <span class="n">filter_dict</span><span class="o">=</span><span class="n">callback_filter</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">callback_func</span><span class="p">)</span> <span class="c"># ...</span>
    <span class="k">return</span> <span class="n">build_canvas</span><span class="p">(</span><span class="n">grps</span><span class="p">)</span>                   <span class="c"># and do the job</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">CmsAnalysisAC3B 0.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Heiner Tholen.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>